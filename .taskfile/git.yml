version: "3"

tasks:
  clear:
    desc: "清除历史提交记录"
    silent: true
    cmds:
      - |
        _branch_name_current=$(git branch --show-current 2>/dev/null || echo "")
        _branch_name_backups="local/bak/${_branch_name_current}/$(date +'%Y/%m/%d/%H%M%S')"
        if [[ "${_branch_name_current}" == "" ]]; then
          echo "当前分支为空，跳过清除 git 缓存"
          exit 0
        fi
        git add -A && git commit -am "clear commit" --no-verify || true
        git rm -r --cached .
        git branch -m ${_branch_name_backups}
        git checkout --orphan ${_branch_name_current}
        git add -A && git commit -am "clear commit" --no-verify || true
        git push -f origin ${_branch_name_current}

  reinit:
    desc: "重新初始化 git"
    cmds:
      - |
        _remote_url=$(git remote get-url origin | head -n1)
        rm -rf .git
        git init --initial-branch=main
        touch README.md
        git add --all
        git commit -m "first commit" --no-verify || true
        git tag -a {{.GIT_TAG_LATEST}} -m "init"
        git remote add origin ${_remote_url}
        git config push.autoSetupRemote true
      - task: clear

  commit:
    desc: "使用 Claude AI 生成提交信息并提交代码"
    cmds:
      - |
        claude -p "use chinese exec git commit"

  push:
    desc: "推送代码"
    cmds:
      - |
        git add --all
        git commit -m '{{.CLI_ARGS | default "Unimportant"}}' || true
        git push || true

  tag:next:
    desc: "创建 tag (参数: [版本等级] [提交信息], 等级: 1=major, 2=minor, 3=patch, 默认 3)"
    vars:
      VERSION_LEVEL: '{{index (splitList " " .CLI_ARGS) 0 | default "3"}}'
      TAG_MESSAGE: '{{slice (splitList " " .CLI_ARGS) 1 | join " "}}'
      GIT_TAG_NEXT:
        sh: |
          level="{{.VERSION_LEVEL}}"
          tag="{{.GIT_TAG_LATEST}}"
          # 提取版本号部分 (去掉 v 前缀)
          version="${tag#v}"
          IFS='.' read -r major minor patch <<< "$version"
          case "$level" in
            1) echo "v$((major + 1)).0.0" ;;
            2) echo "v${major}.$((minor + 1)).0" ;;
            *) echo "v${major}.${minor}.$((patch + 1))" ;;
          esac
    cmds:
      - echo "{{.GIT_TAG_NEXT}}" | sed -r 's/^v//' | { read ver; sed -r 's|^(version =).*|\1 "'"$ver"'"|' pyproject.toml -i >/dev/null 2>&1; } || true
      - task: push
      - |
        git tag -a {{.GIT_TAG_NEXT}} -m '{{.TAG_MESSAGE | default "version bump"}}'
        git push origin {{.GIT_TAG_NEXT}}
